{{ $dbUrl := .Get 0 }}
{{ $dbApiUrl := "" }}

{{ if ( findRE `^.*neodb\.social\/.*` $dbUrl ) }}
    {{ $dbPath := replaceRE `.*neodb.social\/(.*\/.*)` "$1" $dbUrl }}
    {{ $dbApiUrl = print "https://neodb.social/api/" $dbPath }}
{{ else }}
    {{ $dbApiUrl = print "https://neodb.social/api/catalog/fetch?url=" $dbUrl }}
{{ end }}

{{ with resources.GetRemote $dbApiUrl }}
    {{ with .Err }}
        {{ if hugo.IsServer }}
            {{ warnf "Failed to fetch neodb content, Please check if NeoDB is reachable: %s" . }}
            <p style="text-align: center;"><small>远程获取内容失败，请检查 NeoDB 是否可达。</small></p>
        {{ else }}
            {{ errorf "Failed to fetch neodb content, Please check if NeoDB is reachable: %s" . }}
        {{ end }}
    {{ else }}
        {{ $dbFetch := transform.Unmarshal . }}
        {{ $itemRating := 0 }}{{ with $dbFetch.rating }}{{ $itemRating = . }}{{ end }}
            <div class="db-card">
                <div class="db-card-subject">
                    <div class="db-card-post"><img loading="lazy" decoding="async" referrerpolicy="no-referrer" src="{{ $dbFetch.cover_image_url }}" onerror="this.parentElement.remove()"></div>
                    <div class="db-card-content">
                        <div class="db-card-title"><a href="{{ $dbUrl }}" class="cute" target="_blank" rel="noreferrer">{{ $dbFetch.title }}</a></div>
{{/*                            <div class="rating">*/}}
{{/*                                {{ if $dbFetch.rating }}*/}}
{{/*                                <span class="allstardark">*/}}
{{/*                                    <span class="allstarlight" style="width:{{mul 10 $itemRating }}%"></span>*/}}
{{/*                                </span>*/}}
{{/*                                <span class="rating_nums">{{ $itemRating }}</span>*/}}
{{/*                                {{ else }}*/}}
{{/*                                    <span class="rating_nums" style="color:var(--card-separator-color);">评分人数不足</span>*/}}
{{/*                                {{ end }}*/}}
{{/*                            </div>*/}}
                        <div class="db-card-abstract">{{ $dbFetch.brief }}</div>
                    </div>
{{/*                    <div class="db-card-cate">{{ $dbFetch.category }}</div>*/}}
                </div>
            </div>
    {{ end }}
{{ end }}

<style>
    .db-card {
        margin: 2rem 3rem;
        background: var(--body-background);
        border-radius: 8px;
        box-shadow: var(--shadow-l1);
    }

    .db-card-subject {
        display: flex;
        align-items: flex-start;
        line-height: 1.6;
        padding: 12px;
        position: relative
    }

    .db-card-content {
        flex: 1 1 auto
    }

    .db-card-post {
        width: 96px;
        margin-right: 15px;
        display: flex;
        flex: 0 0 auto
    }

    .db-card-title {
        margin-bottom: 5px;
        overflow: hidden;
        font-size: 18px;
        max-height: 3rem
    }

    .db-card-title a {
        text-decoration: none!important
    }

    .db-card-abstract,
    .db-card-comment {
        font-size: 14px;
        overflow: auto;
        max-height: 9rem
    }

    .db-card-cate {
        position: absolute;
        top: 0;
        right: 0;
        background: var(--card-separator-color);
        color: var(--card-text-color-main);
        padding: 1px 8px;
        font-size: small;
        font-style: italic;
        border-radius: 0 8px 0 8px;
        text-transform: capitalize
    }

    .db-card-post img {
        width: 96px!important;
        height: 128px!important;
        border-radius: 4px;
        -o-object-fit: cover;
        object-fit: cover
    }

    .rating {
        margin: 0 0 5px;
        font-size: 13px;
        line-height: 1;
        display: flex;
        align-items: center
    }

    .rating .allstardark {
        position: relative;
        color: var(--accent-color-darker);
        height: 16px;
        width: 80px;
        background-size: auto 100%;
        margin-right: 8px;
        background-repeat: repeat;
        background-image: url(data:image/svg+xml,%3Csvg%20width%3D%22800px%22%20height%3D%22800px%22%20viewBox%3D%220%200%20512%20512%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20stroke%3D%22%23A53860%22%20fill%3D%22%23A53860%22%20d%3D%22M256%2038.013c-22.458%200-66.472%20110.3-84.64%20123.502-18.17%2013.2-136.674%2020.975-143.614%2042.334-6.94%2021.358%2084.362%2097.303%2091.302%20118.662%206.94%2021.36-22.286%20136.465-4.116%20149.665%2018.17%2013.2%20118.61-50.164%20141.068-50.164%2022.458%200%20122.9%2063.365%20141.068%2050.164%2018.17-13.2-11.056-128.306-4.116-149.665%206.94-21.36%2098.242-97.304%2091.302-118.663-6.94-21.36-125.444-29.134-143.613-42.335-18.168-13.2-62.182-123.502-84.64-123.502z%22%2F%3E%3C%2Fsvg%3E)
    }

    .rating .allstarlight {
        position: absolute;
        left: 0;
        color: var(--accent-color);
        height: 16px;
        overflow: hidden;
        background-size: auto 100%;
        background-repeat: repeat;
        background-image: url(data:image/svg+xml,%3Csvg%20width%3D%22800px%22%20height%3D%22800px%22%20viewBox%3D%220%200%20512%20512%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20stroke%3D%22%23A53860%22%20fill%3D%22%23A53860%22%20d%3D%22M256%2038.013c-22.458%200-66.472%20110.3-84.64%20123.502-18.17%2013.2-136.674%2020.975-143.614%2042.334-6.94%2021.358%2084.362%2097.303%2091.302%20118.662%206.94%2021.36-22.286%20136.465-4.116%20149.665%2018.17%2013.2%20118.61-50.164%20141.068-50.164%2022.458%200%20122.9%2063.365%20141.068%2050.164%2018.17-13.2-11.056-128.306-4.116-149.665%206.94-21.36%2098.242-97.304%2091.302-118.663-6.94-21.36-125.444-29.134-143.613-42.335-18.168-13.2-62.182-123.502-84.64-123.502z%22%2F%3E%3C%2Fsvg%3E)
    }

    @media(max-width: 550px) {
        .db-card {
            margin: .8rem 1rem
        }
        .db-card-comment {
            display: none
        }
    }
</style>